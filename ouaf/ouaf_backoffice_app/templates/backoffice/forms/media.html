<div class="media_form__element span-full">
    {% for hidden in form.hidden_fields %}
    {{ hidden }}
    {% endfor %}

    <div class="media_form__data">
        <strong>Informations:</strong>

        <div class="media_form__row js-crop-scope" data-crop-aspect="16/9" data-crop-size="1600x900">
            <label class="media_form__label" for="{{ form.file.id_for_label }}">Fichier</label>
            <div class="media_form__input">
                {{ form.file }}
            </div>
        </div>

        <div class="media_form__row">
            <label class="media_form__label" for="{{ form.url.id_for_label }}">URL</label>
            <div class="media_form__input">
                {{ form.url }}
                <p class="form__help">Image/vidéo distante ou URL YouTube. Laissez vide si vous uploadez un fichier.</p>
            </div>
        </div>

        <div class="media_form__row">
            <label class="media_form__label" for="{{ form.caption.id_for_label }}">Légende</label>
            <div class="media_form__input">
                {{ form.caption }}
            </div>
        </div>

        <div class="media_form__row">
            <label class="media_form__label" for="{{ form.position.id_for_label }}">Ordre</label>
            <div class="media_form__input">
                {{ form.position }}
            </div>
        </div>

        {% if form.DELETE %}
        <a class="btn btn--danger" onclick="document.getElementById('{{ form.DELETE.id_for_label }}').checked=true;this.closest('.media_form__element').style.display='none';">Supprimer</a>
        <div class="media_form__delete">
            {{ form.DELETE }}
        </div>
        {% endif %}
    </div>

    <div class="media_form__preview">
        {% if form.instance.file %}
            <strong>Prévisualisation:</strong>
            <br/>
            <img class="media_form__preview_content js-media-preview" src="{{ form.instance.file.url }}" alt="Prévisualisation"/>
        {% elif form.instance.url and "youtu" in form.instance.url %}
            <strong>Prévisualisation:</strong>
            <br/>
            <div class="media_form__preview_content">
                <button type="button" data-yt="{{ form.instance.url }}"
                        aria-label="Lire la vidéo YouTube"
                        class="yt-thumb js-yt-thumb"
                        style="--yt-thumb: url({{ form.instance.url }});">::after</button>
            </div>
        {% else %}
            <strong>Prévisualisation:</strong>
            <br/>
            <img class="media_form__preview_content js-media-preview" alt="Prévisualisation" style="display:none;"/>
        {% endif %}
    </div>

    <div class="fieldWrapper">
        {% for field in form.visible_fields %}
        {% if field.errors %}
        {{ field.errors }}
        {{ field.label_tag }} {{ field }}
        {% endif %}
        {% endfor %}
    </div>

    <!-- AJOUT: initialise les attributs sur l'input file rendu -->
    <script>
      (function(root){
        try{
          const scope = root.querySelector('.js-crop-scope');
          const input = scope && scope.querySelector('input[type="file"]');
          if(!input) return;
          input.setAttribute('data-autocrop','1');
          input.setAttribute('accept','image/*');
        }catch(e){}
      })(document.currentScript.closest('.media_form__element'));
    </script>

    <script>
        // Pose les miniatures au DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.js-yt-thumb').forEach(btn => {
                const id = ytIdFromUrl(btn.dataset.yt || '');
                if (!id) {
                    btn.outerHTML = '<span>Vidéo indisponible</span>';
                    return;
                }
                btn.style.setProperty('--yt-thumb', `url(https://img.youtube.com/vi/${id}/hqdefault.jpg)`);
                // click -> remplace par iframe (pas de gestion “unique”, on autorise plusieurs players)
                btn.addEventListener('click', () => {
                    const iframe = document.createElement('iframe');
                    iframe.src = `https://www.youtube.com/embed/${id}?autoplay=1&rel=0`;
                    iframe.title = 'YouTube video';
                    iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
                    iframe.allowFullscreen = true;
                    iframe.style.width = '100%';
                    iframe.style.height = '100%';
                    // wrapper pour garder le ratio du slide
                    const wrap = document.createElement('div');
                    wrap.appendChild(iframe);
                    btn.replaceWith(wrap);
                }, {once: true});
            });
        });

        function ytIdFromUrl(u) {
            try {
                const a = document.createElement('a');
                a.href = u;
                if (a.hostname.includes('youtu.be')) return a.pathname.slice(1);
                const p = new URLSearchParams(a.search);
                if (p.get('v')) return p.get('v');
                const parts = a.pathname.split('/');
                const i = parts.indexOf('embed');
                if (i >= 0 && parts[i + 1]) return parts[i + 1];
            } catch (e) {
            }
            return null;
        }
        </script>
</div>
