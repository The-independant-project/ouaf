{% extends "base.html" %}
{% load static %}

{% block subtitle %} – Activités{% endblock %}

{% block content %}
    <section class="activities" aria-labelledby="activities-title">
        <header class="activities__header">
            {% include "html/ouaf_h1.html" with text="Activités – "|add:category.title %}
            <p class="activities__intro">Découvrez les activités de la catégorie « {{ category.title }} ».</p>
        </header>

        <ul class="activities__rows" role="list">
            {# On s’appuie sur Meta.ordering (position, id) défini sur ActivityMedia. #}
            {% for a in activities %}
                {% with media_list=a.media.all %}
                    {% with primary=media_list|first others=media_list|slice:"1:" %}
                        <li class="activities__row {% if not forloop.counter0|divisibleby:2 %}is-reverse{% endif %}">
                            <!-- Média principal (colonne 1 ou 2 selon alternance) -->
                            <figure class="activities__media">
                                {% if primary %}
                                    {% if primary.is_image %}
                                        <img
                                                src="{{ primary.file.url|default:primary.url }}"
                                                alt="{{ primary.caption|default:a.title }}"
                                                loading="lazy" decoding="async">
                                    {% elif primary.is_video %}
                                        {% if "youtu" in primary.url %}
                                            <!-- Wrapper ratio 16/9 pour YouTube -->
                                            <div class="js-yt-embed" data-yt="{{ primary.url }}"></div>
                                        {% else %}
                                            <video src="{{ primary.file.url|default:primary.url }}" controls playsinline
                                                   preload="metadata"></video>
                                        {% endif %}
                                    {% else %}
                                        <div class="activities__mediaFallback">
                                            <a class="activities__ytLink"
                                               href="{{ primary.file.url|default:primary.url }}" target="_blank"
                                               rel="noopener">
                                                Ouvrir le média
                                            </a>
                                        </div>
                                    {% endif %}
                                {% else %}
                                    <div class="activities__mediaFallback">
                                        <img src="{% static 'images/avatar_placeholder.svg' %}" alt="Média indisponible"
                                             style="max-width:240px;">
                                    </div>
                                {% endif %}
                            </figure>

                            <!-- Titre + description (colonne opposée) -->
                            <div class="activities__content">
                                <h2 class="activities__title">{{ a.title }}</h2>
                                <p class="activities__desc">{{ a.description }}</p>
                            </div>

                            <!-- Carrousel (pleine largeur, SOUS les 2 colonnes) -->
                            {% if others %}
                                <div class="activities__carousel">
                                    <div class="mediaCarousel">
                                        <div class="owl-carousel owl-theme js-owl">
                                            {% for m in others %}
                                                {# --- SLIDE IMAGE --- #}
                                                {% if m.is_image %}
                                                    <div class="item mediaCarousel__slide">
                                                        <img src="{{ m.file.url|default:m.url }}"
                                                             alt="{{ m.caption|default:a.title }}">
                                                    </div>

                                                    {# --- SLIDE VIDEO (YouTube gérée maison) --- #}
                                                {% elif m.is_video and "youtu" in m.url %}
                                                    <div class="item mediaCarousel__slide">
                                                        <button class="yt-thumb js-yt-thumb"
                                                                type="button"
                                                                data-yt="{{ m.url }}"
                                                                aria-label="Lire la vidéo YouTube">
                                                        </button>
                                                    </div>

                                                    {# --- SLIDE VIDEO FICHIER --- #}
                                                {% elif m.is_video %}
                                                    <div class="item mediaCarousel__slide">
                                                        <video src="{{ m.file.url|default:m.url }}" controls playsinline
                                                               preload="metadata"></video>
                                                    </div>

                                                    {# --- SLIDE LIEN AUTRE --- #}
                                                {% else %}
                                                    <div class="item mediaCarousel__slide">
                                                        <a class="mediaCarousel__link"
                                                           href="{{ m.file.url|default:m.url }}" target="_blank"
                                                           rel="noopener">
                                                            Ouvrir le média
                                                        </a>
                                                    </div>
                                                {% endif %}

                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        </li>
                    {% endwith %}
                {% endwith %}
            {% empty %}
                <li>Aucune activité dans cette catégorie pour le moment.</li>
            {% endfor %}
        </ul>
    </section>

    <!-- Image Modal (lightbox) -->
    <div class="mediaModal js-media-modal" role="dialog" aria-modal="true" aria-label="Agrandissement d'image" hidden>
        <div class="mediaModal__dialog">
            <button type="button" class="mediaModal__btn mediaModal__prev" aria-label="Image précédente">‹</button>
            <div class="mediaModal__imgWrap">
                <img class="mediaModal__img" alt="">
            </div>
            <button type="button" class="mediaModal__btn mediaModal__next" aria-label="Image suivante">›</button>
            <button type="button" class="mediaModal__btn mediaModal__close" aria-label="Fermer">✕</button>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.js-yt-embed').forEach(el => {
                const url = el.getAttribute('data-yt') || '';

                function ytId(u) {
                    try {
                        const a = document.createElement('a');
                        a.href = u;
                        if (a.hostname.includes('youtu.be')) return a.pathname.slice(1);
                        const p = new URLSearchParams(a.search);
                        if (p.get('v')) return p.get('v');
                        const parts = a.pathname.split('/');
                        const i = parts.indexOf('embed');
                        if (i >= 0 && parts[i + 1]) return parts[i + 1];
                    } catch (e) {
                    }
                    return null;
                }

                const id = ytId(url);
                if (!id) {
                    el.innerHTML = '<a class="activities__ytLink" href="' + url + '" target="_blank" rel="noopener">Voir la vidéo sur YouTube</a>';
                    return;
                }

                const iframe = document.createElement('iframe');
                iframe.src = 'https://www.youtube.com/embed/' + id + '?rel=0';
                iframe.title = 'YouTube video';
                iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
                iframe.allowFullscreen = true;
                el.replaceChildren(iframe);
            });
        });


        (function bootOwl() {
            if (!window.jQuery) return setTimeout(bootOwl, 120);
            if (!jQuery.fn || !jQuery.fn.owlCarousel) return setTimeout(bootOwl, 120);

            jQuery(function ($) {
                $('.js-owl').each(function () {
                    const $owl = $(this);
                    if (!$owl.children().length) return;

                    $owl.owlCarousel({
                        items: 3,
                        margin: 16,
                        nav: true,
                        dots: true,
                        loop: false,
                        autoHeight: false,
                        stagePadding: 8,
                        responsive: {
                            0: {items: 1, stagePadding: 0, margin: 12},
                            600: {items: 2},
                            1024: {items: 3}
                        },
                        onInitialized: () => setTimeout(() => $owl.trigger('refresh.owl.carousel'), 200)
                    });


                    $owl.find('img').each(function () {
                        if (this.complete) return;
                        $(this).on('load', () => $owl.trigger('refresh.owl.carousel'));
                    });

                    $owl.on('loaded.owl.lazy', () => $owl.trigger('refresh.owl.carousel'));
                    setTimeout(() => $owl.trigger('refresh.owl.carousel'), 250);
                });
            });
        })();

        function ytIdFromUrl(u) {
            try {
                const a = document.createElement('a');
                a.href = u;
                if (a.hostname.includes('youtu.be')) return a.pathname.slice(1);
                const p = new URLSearchParams(a.search);
                if (p.get('v')) return p.get('v');
                const parts = a.pathname.split('/');
                const i = parts.indexOf('embed');
                if (i >= 0 && parts[i + 1]) return parts[i + 1];
            } catch (e) {
            }
            return null;
        }

        // Pose les miniatures au DOMContentLoaded
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.js-yt-thumb').forEach(btn => {
                const id = ytIdFromUrl(btn.dataset.yt || '');
                if (!id) {
                    btn.outerHTML = '<span>Vidéo indisponible</span>';
                    return;
                }
                btn.style.setProperty('--yt-thumb', `url(https://img.youtube.com/vi/${id}/hqdefault.jpg)`);
                // click -> remplace par iframe (pas de gestion “unique”, on autorise plusieurs players)
                btn.addEventListener('click', () => {
                    const iframe = document.createElement('iframe');
                    iframe.src = `https://www.youtube.com/embed/${id}?autoplay=1&rel=0`;
                    iframe.title = 'YouTube video';
                    iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
                    iframe.allowFullscreen = true;
                    iframe.style.width = '100%';
                    iframe.style.height = '100%';
                    // wrapper pour garder le ratio du slide
                    const wrap = document.createElement('div');
                    wrap.className = 'yt-iframe-wrap';
                    wrap.appendChild(iframe);
                    btn.replaceWith(wrap);
                }, {once: true});
            });
        });
    </script>




    <script>
        /**
         * Clamp .activities__desc to fit under the media height (desktop only).
         * Keeps the image anchored; only the text expands/collapses.
         */
        (() => {
            const rows = document.querySelectorAll('.activities__row');
            const mq = window.matchMedia('(max-width: 768px)');

            const debounce = (fn, d = 120) => {
                let t;
                return (...a) => {
                    clearTimeout(t);
                    t = setTimeout(() => fn(...a), d);
                };
            };

            function clampRow(row) {
                const media = row.querySelector('.activities__media');
                const content = row.querySelector('.activities__content');
                const title = row.querySelector('.activities__title');
                const desc = row.querySelector('.activities__desc');
                if (!media || !content || !desc) return;

                // In stacked layout (mobile), remove dynamic clamp.
                if (mq.matches) {
                    content.classList.remove('is-clamped', 'is-expanded');
                    desc.style.removeProperty('--line-clamp');
                    const b = content.querySelector('.activities__moreBtn');
                    if (b) b.remove();
                    return;
                }

                // Compute how many lines fit under the media height.
                const mediaH = media.clientHeight;
                const titleH = title ? title.clientHeight : 0;
                const gap = parseFloat(getComputedStyle(content).rowGap || 0);
                const avail = Math.max(0, mediaH - titleH - gap);
                const lineH = parseFloat(getComputedStyle(desc).lineHeight) || 24;
                const lines = Math.max(2, Math.floor(avail / lineH));

                content.classList.add('is-clamped');
                content.classList.remove('is-expanded');
                desc.style.setProperty('--line-clamp', String(lines));

                // Show toggle only when overflow actually occurs.
                requestAnimationFrame(() => {
                    const needs = desc.scrollHeight > desc.clientHeight + 1;
                    let btn = content.querySelector('.activities__moreBtn');

                    if (needs) {
                        if (!btn) {
                            btn = document.createElement('button');
                            btn.type = 'button';
                            btn.className = 'activities__moreBtn';
                            btn.textContent = 'Voir plus';
                            btn.addEventListener('click', () => {
                                const expanded = content.classList.toggle('is-expanded');
                                btn.textContent = expanded ? 'Voir moins' : 'Voir plus';
                            });
                            content.appendChild(btn);
                        }
                        btn.hidden = false;
                    } else if (btn) {
                        btn.hidden = true;
                    }
                });
            }

            function runAll() {
                rows.forEach(clampRow);
            }

            // Recompute on load and on resize (debounced).
            window.addEventListener('load', runAll);
            window.addEventListener('resize', debounce(runAll, 120));

            // Recompute once media (images) load, in case sizes change after onload.
            rows.forEach(row => {
                const img = row.querySelector('.activities__media img');
                if (img) {
                    if (img.complete) return;          // already loaded
                    img.addEventListener('load', runAll, {once: true});
                }
            });
        })();
    </script>


    <script>
        /**
         * Lightweight image modal for carousel images.
         * - Opens when clicking an image inside .mediaCarousel of a row
         * - Keyboard: Esc (close), ←/→ (nav), Tab trap within controls
         * - Restores focus to the opener, body scroll locked while open
         */
        (() => {
            const modal = document.querySelector('.js-media-modal');
            if (!modal) return;

            const imgEl = modal.querySelector('.mediaModal__img');
            const btnPrev = modal.querySelector('.mediaModal__prev');
            const btnNext = modal.querySelector('.mediaModal__next');
            const btnClose = modal.querySelector('.mediaModal__close');

            let gallery = [];
            let index = 0;
            let lastFocused = null;

            function collectImagesFromRow(row) {
                const set = new Set();
                const list = [];
                row.querySelectorAll('.activities__carousel .mediaCarousel__slide img').forEach(img => {
                    const src = img.getAttribute('src');
                    if (src && !set.has(src)) {
                        set.add(src);
                        list.push({src, alt: img.getAttribute('alt') || ''});
                    }
                });
                return list;
            }

            function render() {
                const item = gallery[index];
                if (!item) return;
                imgEl.src = item.src;
                imgEl.alt = item.alt;
            }

            function openWith(list, startIdx, trigger) {
                gallery = list.slice();
                index = Math.max(0, Math.min(startIdx || 0, gallery.length - 1));
                lastFocused = document.activeElement;

                render();
                modal.hidden = false;
                modal.classList.add('is-open');
                document.body.style.overflow = 'hidden';
                // initial focus
                btnClose.focus();
                // Click outside image closes
                modal.addEventListener('click', backdropClose, {once: true, capture: true});
                document.addEventListener('keydown', onKey);
            }

            function close() {
                modal.classList.remove('is-open');
                modal.hidden = true;
                document.body.style.overflow = '';
                document.removeEventListener('keydown', onKey);
                if (lastFocused && typeof lastFocused.focus === 'function') lastFocused.focus();
            }

            function next() {
                index = (index + 1) % gallery.length;
                render();
            }

            function prev() {
                index = (index - 1 + gallery.length) % gallery.length;
                render();
            }

            function onKey(e) {
                if (e.key === 'Escape') {
                    e.preventDefault();
                    close();
                } else if (e.key === 'ArrowRight') {
                    e.preventDefault();
                    next();
                } else if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    prev();
                } else if (e.key === 'Tab') {
                    const nodes = [btnPrev, btnNext, btnClose].filter(Boolean);
                    const i = nodes.indexOf(document.activeElement);
                    const dir = e.shiftKey ? -1 : 1;
                    const ni = (i + dir + nodes.length) % nodes.length;
                    e.preventDefault();
                    nodes[ni].focus();
                }
            }

            function backdropClose(e) {
                const dialog = modal.querySelector('.mediaModal__dialog');
                if (!dialog.contains(e.target)) close();
            }

            // Wire buttons
            btnPrev.addEventListener('click', prev);
            btnNext.addEventListener('click', next);
            btnClose.addEventListener('click', close);

            // Delegate: open on image click inside each row's carousel
            document.querySelectorAll('.activities__row').forEach(row => {
                const container = row.querySelector('.mediaCarousel');
                if (!container) return;

                container.addEventListener('click', (evt) => {
                    const img = evt.target.closest('img');
                    if (!img) return; // ignore clicks on videos/links
                    const list = collectImagesFromRow(row);
                    if (!list.length) return;

                    const start = Math.max(0, list.findIndex(i => i.src === img.getAttribute('src')));
                    openWith(list, start, img);
                });
            });
        })();
    </script>



{% endblock %}
